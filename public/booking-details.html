<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Details - BusTicket Pro</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="style.css" rel="stylesheet">
    <style>
        .booking-details-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .booking-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 25px 25px 0 0;
            padding: 2rem;
        }
        
        .passenger-detail {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        .route-summary {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px solid rgba(33, 150, 243, 0.2);
        }
        
        .price-highlight {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .status-badge {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            display: inline-block;
        }
        
        .qr-code {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            border: 2px dashed #ddd;
        }
        
        .print-btn {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            border: none;
            color: white;
            padding: 1rem 2rem;
            border-radius: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .print-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.3);
        }
        
        .editable-booking-details {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-radius: 20px;
            padding: 2rem;
            border: 2px solid rgba(255, 193, 7, 0.3);
        }
        
        .editable-booking-details .form-control,
        .editable-booking-details .form-select {
            border-radius: 15px;
            border: 2px solid rgba(255, 193, 7, 0.2);
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .editable-booking-details .form-control:focus,
        .editable-booking-details .form-select:focus {
            border-color: #ffc107;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        }
        
        .editable-booking-details .btn-warning {
            background: linear-gradient(135deg, #ffc107, #ffb300);
            border: none;
            color: #000;
            padding: 0.75rem 2rem;
            border-radius: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .editable-booking-details .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
        }
        
        #editablePassengerForms {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            border-radius: 20px;
            padding: 2rem;
            border: 2px solid rgba(40, 167, 69, 0.3);
            margin-top: 2rem;
        }
        
        #editablePassengerForms .passenger-detail {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(40, 167, 69, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        #editablePassengerForms .form-control {
            border-radius: 10px;
            border: 2px solid rgba(40, 167, 69, 0.2);
            transition: all 0.3s ease;
        }
        
        #editablePassengerForms .form-control:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        
        /* Print Styles */
        @media print {
            .navbar,
            .btn,
            footer,
            .editable-booking-details,
            #editablePassengerForms {
                display: none !important;
            }
            
            .booking-details-card {
                box-shadow: none !important;
                border: 2px solid #000 !important;
            }
            
            .booking-header {
                background: #f8f9fa !important;
                color: #000 !important;
                border: 2px solid #000 !important;
            }
            
            .route-summary {
                background: #f8f9fa !important;
                border: 2px solid #000 !important;
            }
            
            .price-highlight {
                background: #f8f9fa !important;
                color: #000 !important;
                border: 2px solid #000 !important;
            }
            
            .passenger-detail {
                background: #f8f9fa !important;
                border: 2px solid #000 !important;
            }
            
            .qr-code {
                background: #f8f9fa !important;
                border: 2px solid #000 !important;
            }
            
            /* Ensure only the main passenger details are visible in print */
            #passengerDetails {
                display: block !important;
            }
            
            /* Hide any other editing elements */
            .form-control,
            .form-select,
            .alert {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-bus me-2"></i>
                BusTicket Pro
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>Back to Home
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card booking-details-card border-0">
                    <!-- Booking Header -->
                    <div class="booking-header text-center">
                        <div class="mb-3">
                            <i class="fas fa-check-circle fa-3x text-success"></i>
                        </div>
                        <h2 class="mb-2">Booking Confirmed!</h2>
                        <p class="mb-0">Your bus ticket has been successfully booked</p>
                        <div class="mt-3">
                            <span class="status-badge">
                                <i class="fas fa-ticket-alt me-2"></i>Confirmed
                            </span>
                        </div>
                        <div class="mt-2" id="dataSourceInfo" style="display: none;">
                            <small class="text-white-50">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="dataSourceText"></span>
                            </small>
                        </div>
                    </div>

                    <div class="card-body p-4">
                        <!-- Booking ID -->
                        <div class="text-center mb-4">
                            <h5 class="text-muted">Booking ID</h5>
                            <h3 class="text-primary" id="bookingId">Loading...</h3>
                        </div>

                        <!-- Route Summary -->
                        <div class="route-summary">
                            <h4 class="mb-3">
                                <i class="fas fa-route me-2 text-primary"></i>
                                Route Details
                            </h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                        <div>
                                            <small class="text-muted">From</small>
                                            <div class="fw-bold" id="fromCity">Loading...</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-map-marker text-success me-2"></i>
                                        <div>
                                            <small class="text-muted">To</small>
                                            <div class="fw-bold" id="toCity">Loading...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <small class="text-muted">Departure</small>
                                        <div class="fw-bold" id="departureTime">Loading...</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <small class="text-muted">Arrival</small>
                                        <div class="fw-bold" id="arrivalTime">Loading...</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <small class="text-muted">Duration</small>
                                        <div class="fw-bold" id="duration">Loading...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <small class="text-muted">Bus Type</small>
                                        <div class="fw-bold" id="busType">Loading...</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <small class="text-muted">Travel Date</small>
                                        <div class="fw-bold" id="travelDate">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Editable Booking Details -->
                        <div class="editable-booking-details mb-4">
                            <h4 class="mb-3">
                                <i class="fas fa-edit me-2 text-warning"></i>
                                Modify Booking Details
                            </h4>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-calendar-alt me-2 text-warning"></i>Travel Date
                                    </label>
                                    <input type="date" class="form-control" id="editableTravelDate" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-users me-2 text-info"></i>Number of Passengers
                                    </label>
                                    <select class="form-select" id="editablePassengers" required>
                                        <option value="1">1 Passenger</option>
                                        <option value="2">2 Passengers</option>
                                        <option value="3">3 Passengers</option>
                                        <option value="4">4 Passengers</option>
                                        <option value="5">5 Passengers</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-warning" id="updateBookingBtn">
                                    <i class="fas fa-save me-2"></i>Update Booking
                                </button>
                            </div>
                        </div>

                                                 <!-- Price Highlight -->
                         <div class="price-highlight">
                             <h4 class="mb-2">Total Amount</h4>
                             <h2 class="mb-0">₹<span id="totalAmount">0</span></h2>
                             <small>Amount paid successfully</small>
                             <div class="mt-2" id="priceBreakdown" style="display: none;">
                                 <small class="text-white-50">
                                     <i class="fas fa-info-circle me-1"></i>
                                     <span id="priceBreakdownText"></span>
                                 </small>
                             </div>
                         </div>

                                                 <!-- Passenger Details -->
                         <div class="mb-4">
                             <h4 class="mb-3">
                                 <i class="fas fa-users me-2 text-primary"></i>
                                 Passenger Details
                             </h4>
                             <div id="passengerDetails">
                                 <!-- Passenger details will be populated here -->
                             </div>
                             
                             <!-- Editable Passenger Forms (shown when editing) -->
                             <div id="editablePassengerForms" style="display: none;">
                                 <h5 class="mb-3 text-warning">
                                     <i class="fas fa-edit me-2"></i>
                                     Edit Passenger Information
                                 </h5>
                                 <div id="passengerFormFields">
                                     <!-- Editable passenger forms will be generated here -->
                                 </div>
                             </div>
                         </div>

                        <!-- QR Code Section -->
                        <div class="qr-code mb-4">
                            <h5 class="mb-3">Your Ticket QR Code</h5>
                            <div class="mb-3">
                                <i class="fas fa-qrcode fa-5x text-primary"></i>
                            </div>
                            <p class="text-muted mb-0">Show this QR code to the bus conductor</p>
                        </div>

                        <!-- Action Buttons -->
                        <div class="text-center">
                            <button class="btn print-btn me-3" onclick="window.print()">
                                <i class="fas fa-print me-2"></i>Print Ticket
                            </button>
                            <a href="/" class="btn btn-outline-primary">
                                <i class="fas fa-home me-2"></i>Back to Home
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 text-center mt-5">
        <p>&copy; 2024 BusTicket Pro. All rights reserved.</p>
    </footer>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class BookingDetailsPage {
            constructor() {
                this.bookingId = this.getBookingIdFromUrl();
                this.init();
            }

            getBookingIdFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id') || localStorage.getItem('currentBookingId') || 'DEMO-001';
            }

            async init() {
                await this.loadBookingData();
                this.displayBookingDetails();
                this.loadPassengerDetails();
                this.setupEditableFields();
                this.setupEventListeners();
            }

            async loadBookingData() {
                try {
                    // Try to get booking data from localStorage first (from the main page)
                    const storedBookingData = localStorage.getItem('currentBookingData');
                    if (storedBookingData) {
                        this.bookingData = JSON.parse(storedBookingData);
                        console.log('Loaded booking data from localStorage:', this.bookingData);
                        this.showDataSourceInfo('Showing your actual booking details');
                        return;
                    }

                    // If no stored data, try to fetch from server
                    const response = await fetch(`/api/booking/${this.bookingId}`, {
                        headers: {
                            'x-auth-status': 'true'
                        }
                    });

                    if (response.ok) {
                        this.bookingData = await response.json();
                        console.log('Loaded booking data from server:', this.bookingData);
                        this.showDataSourceInfo('Showing your actual booking details');
                    } else {
                        console.log('Server request failed, using demo data');
                        // Fallback to demo data if server request fails
                        this.bookingData = this.getDemoData();
                        this.showDataSourceInfo('Showing demo data - no actual booking found');
                    }
                } catch (error) {
                    console.error('Error loading booking data:', error);
                    // Fallback to demo data
                    this.bookingData = this.getDemoData();
                    this.showDataSourceInfo('Showing demo data - no actual booking found');
                }
            }

            showDataSourceInfo(message) {
                const infoElement = document.getElementById('dataSourceInfo');
                const textElement = document.getElementById('dataSourceText');
                if (infoElement && textElement) {
                    textElement.textContent = message;
                    infoElement.style.display = 'block';
                }
            }

            getDemoData() {
                // This will be used as fallback if no real data is available
                return {
                    id: this.bookingId,
                    from: 'Mumbai',
                    to: 'Delhi',
                    departureTime: '08:00 AM',
                    arrivalTime: '08:00 PM',
                    duration: '12h',
                    busType: 'Premium',
                    travelDate: '2024-01-15',
                    totalAmount: 2500,
                    passengers: [
                        {
                            firstName: 'Rahul',
                            lastName: 'Sharma',
                            email: 'rahul.sharma@email.com',
                            phone: '+91 98765 43210'
                        },
                        {
                            firstName: 'Priya',
                            lastName: 'Patel',
                            email: 'priya.patel@email.com',
                            phone: '+91 98765 43211'
                        }
                    ]
                };
            }

            displayBookingDetails() {
                if (!this.bookingData) {
                    console.error('No booking data available');
                    return;
                }

                // Update the UI with actual booking data
                document.getElementById('bookingId').textContent = this.bookingData.id;
                document.getElementById('fromCity').textContent = this.bookingData.from;
                document.getElementById('toCity').textContent = this.bookingData.to;
                document.getElementById('departureTime').textContent = this.bookingData.departureTime;
                document.getElementById('arrivalTime').textContent = this.bookingData.arrivalTime;
                document.getElementById('duration').textContent = this.bookingData.duration;
                document.getElementById('busType').textContent = this.bookingData.busType;
                
                // Handle travel date - use current date if not available
                const travelDate = this.bookingData.travelDate || new Date().toISOString();
                document.getElementById('travelDate').textContent = this.formatDate(travelDate);
                
                document.getElementById('totalAmount').textContent = this.bookingData.totalAmount;
            }

            loadPassengerDetails() {
                if (!this.bookingData || !this.bookingData.passengers) return;

                const container = document.getElementById('passengerDetails');
                container.innerHTML = '';

                this.bookingData.passengers.forEach((passenger, index) => {
                    const passengerHtml = `
                        <div class="passenger-detail">
                            <h6 class="mb-3">
                                <i class="fas fa-user me-2 text-primary"></i>
                                Passenger ${index + 1}
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted">Name</small>
                                        <div class="fw-bold">${passenger.firstName} ${passenger.lastName}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted">Email</small>
                                        <div class="fw-bold">${passenger.email}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted">Phone</small>
                                        <div class="fw-bold">${passenger.phone}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted">Seat Number</small>
                                        <div class="fw-bold">A${index + 1}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += passengerHtml;
                });
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-IN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

                         setupEditableFields() {
                 // Set up date validation (can't select past dates)
                 const today = new Date().toISOString().split('T')[0];
                 document.getElementById('editableTravelDate').setAttribute('min', today);
                 
                 // Populate editable fields with current values
                 if (this.bookingData) {
                     // Set travel date
                     const travelDateInput = document.getElementById('editableTravelDate');
                     if (travelDateInput && this.bookingData.travelDate) {
                         travelDateInput.value = this.bookingData.travelDate;
                     }
                     
                     // Set passenger count
                     const passengerSelect = document.getElementById('editablePassengers');
                     if (passengerSelect && this.bookingData.passengers) {
                         passengerSelect.value = this.bookingData.passengers.length;
                     }
                     
                     // Show editable passenger forms by default
                     this.updateEditablePassengerForms(this.bookingData.passengers.length);
                 }
             }

            setupEventListeners() {
                // Update button click
                const updateBtn = document.getElementById('updateBookingBtn');
                if (updateBtn) {
                    updateBtn.addEventListener('click', () => {
                        this.updateBooking();
                    });
                }

                // Date change event
                const dateInput = document.getElementById('editableTravelDate');
                if (dateInput) {
                    dateInput.addEventListener('change', () => {
                        this.updateTotalAmount();
                    });
                }

                // Passenger count change event
                const passengerSelect = document.getElementById('editablePassengers');
                if (passengerSelect) {
                    passengerSelect.addEventListener('change', () => {
                        this.updateTotalAmount();
                        this.updatePassengerForms();
                    });
                }
            }

                         updateTotalAmount() {
                 if (!this.bookingData) return;
                 
                 const newDate = document.getElementById('editableTravelDate').value;
                 const newPassengerCount = parseInt(document.getElementById('editablePassengers').value);
                 
                 // Calculate price per passenger from the original total amount
                 // We need to get the base price per passenger from the original booking
                 let basePricePerPassenger;
                 
                 if (this.bookingData.originalTotalAmount) {
                     // Use stored original amount if available
                     basePricePerPassenger = this.bookingData.originalTotalAmount / this.bookingData.originalPassengerCount;
                 } else {
                     // Calculate from current data and store for future use
                     this.bookingData.originalTotalAmount = this.bookingData.totalAmount;
                     this.bookingData.originalPassengerCount = this.bookingData.passengers.length;
                     basePricePerPassenger = this.bookingData.totalAmount / this.bookingData.passengers.length;
                 }
                 
                 // Calculate new total amount
                 const newTotalAmount = basePricePerPassenger * newPassengerCount;
                 
                 // Update the display
                 document.getElementById('totalAmount').textContent = newTotalAmount;
                 
                 // Show price breakdown
                 this.showPriceBreakdown(basePricePerPassenger, newPassengerCount, newTotalAmount);
                 
                 // Update the travel date display
                 if (newDate) {
                     document.getElementById('travelDate').textContent = this.formatDate(newDate);
                 }
             }

                         updatePassengerForms() {
                 if (!this.bookingData) return;
                 
                 const newPassengerCount = parseInt(document.getElementById('editablePassengers').value);
                 
                 // Update the display view
                 this.updatePassengerDisplay(newPassengerCount);
                 
                 // Update the editable forms
                 this.updateEditablePassengerForms(newPassengerCount);
                 
                 // Also update the main passenger details section to keep everything in sync
                 this.loadPassengerDetails();
             }
            
            updatePassengerDisplay(passengerCount) {
                const container = document.getElementById('passengerDetails');
                container.innerHTML = '';
                
                for (let i = 1; i <= passengerCount; i++) {
                    let passengerData = this.bookingData.passengers[i - 1] || {
                        firstName: `Passenger ${i}`,
                        lastName: '',
                        email: '',
                        phone: ''
                    };
                    
                    const passengerHtml = `
                        <div class="passenger-detail">
                            <h6 class="mb-3">
                                <i class="fas fa-user me-2 text-primary"></i>
                                Passenger ${i}
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                         <small class="text-muted">Name</small>
                                         <div class="fw-bold">${passengerData.firstName} ${passengerData.lastName}</div>
                                     </div>
                                 </div>
                                 <div class="col-md-6">
                                     <div class="mb-2">
                                         <small class="text-muted">Email</small>
                                         <div class="fw-bold">${passengerData.email}</div>
                                     </div>
                                 </div>
                                 <div class="col-md-6">
                                     <div class="mb-2">
                                         <small class="text-muted">Phone</small>
                                         <div class="fw-bold">${passengerData.phone}</div>
                                     </div>
                                 </div>
                                 <div class="col-md-6">
                                     <div class="mb-2">
                                         <small class="text-muted">Seat Number</small>
                                         <div class="fw-bold">A${i}</div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     `;
                     container.innerHTML += passengerHtml;
                 }
             }
             
             updateEditablePassengerForms(passengerCount) {
                 const container = document.getElementById('passengerFormFields');
                 const editableSection = document.getElementById('editablePassengerForms');
                 
                 if (!container || !editableSection) return;
                 
                 container.innerHTML = '';
                 
                 for (let i = 1; i <= passengerCount; i++) {
                     let passengerData = this.bookingData.passengers[i - 1] || {
                         firstName: '',
                         lastName: '',
                         email: '',
                         phone: ''
                     };
                     
                     const formHtml = `
                         <div class="passenger-detail mb-3">
                             <h6 class="mb-3">
                                 <i class="fas fa-user me-2 text-warning"></i>
                                 Passenger ${i}
                             </h6>
                             <div class="row g-3">
                                 <div class="col-md-6">
                                     <label class="form-label">First Name</label>
                                     <input type="text" class="form-control" id="editFirstName_${i}" 
                                            value="${passengerData.firstName}" placeholder="Enter first name">
                                 </div>
                                 <div class="col-md-6">
                                     <label class="form-label">Last Name</label>
                                     <input type="text" class="form-control" id="editLastName_${i}" 
                                            value="${passengerData.lastName}" placeholder="Enter last name">
                                     </div>
                                 <div class="col-md-6">
                                     <label class="form-label">Email</label>
                                     <input type="email" class="form-control" id="editEmail_${i}" 
                                            value="${passengerData.email}" placeholder="Enter email">
                                 </div>
                                 <div class="col-md-6">
                                     <label class="form-label">Phone</label>
                                     <input type="tel" class="form-control" id="editPhone_${i}" 
                                            value="${passengerData.phone}" placeholder="Enter phone number">
                                 </div>
                             </div>
                         </div>
                     `;
                     container.innerHTML += formHtml;
                 }
                 
                 // Show the editable section
                 editableSection.style.display = 'block';
             }

            updateBooking() {
                const newDate = document.getElementById('editableTravelDate').value;
                const newPassengerCount = parseInt(document.getElementById('editablePassengers').value);
                
                if (!newDate) {
                    alert('Please select a travel date');
                    return;
                }
                
                // Update the stored booking data
                if (this.bookingData) {
                    this.bookingData.travelDate = newDate;
                    
                    // Collect passenger data from editable forms
                    const updatedPassengers = [];
                    for (let i = 1; i <= newPassengerCount; i++) {
                        const firstName = document.getElementById(`editFirstName_${i}`)?.value || '';
                        const lastName = document.getElementById(`editLastName_${i}`)?.value || '';
                        const email = document.getElementById(`editEmail_${i}`)?.value || '';
                        const phone = document.getElementById(`editPhone_${i}`)?.value || '';
                        
                        updatedPassengers.push({
                            firstName: firstName || `Passenger ${i}`,
                            lastName: lastName,
                            email: email,
                            phone: phone
                        });
                    }
                    
                    // Update passenger data
                    this.bookingData.passengers = updatedPassengers;
                    
                                         // Update total amount using the base price per passenger
                     let basePricePerPassenger;
                     if (this.bookingData.originalTotalAmount) {
                         basePricePerPassenger = this.bookingData.originalTotalAmount / this.bookingData.originalPassengerCount;
                     } else {
                         // Calculate and store base price if not already stored
                         this.bookingData.originalTotalAmount = this.bookingData.totalAmount;
                         this.bookingData.originalPassengerCount = this.bookingData.passengers.length;
                         basePricePerPassenger = this.bookingData.totalAmount / this.bookingData.passengers.length;
                     }
                     
                     this.bookingData.totalAmount = basePricePerPassenger * newPassengerCount;
                    
                    // Update localStorage
                    localStorage.setItem('currentBookingData', JSON.stringify(this.bookingData));
                    
                    // Refresh the display view (this is what gets printed)
                    this.updatePassengerDisplay(newPassengerCount);
                    
                    // Also refresh the main passenger details section
                    this.loadPassengerDetails();
                    
                    // Update the total amount display
                    document.getElementById('totalAmount').textContent = this.bookingData.totalAmount;
                    
                    // Update the travel date display
                    document.getElementById('travelDate').textContent = this.formatDate(newDate);
                    
                    // Show success message
                    this.showUpdateSuccess();
                }
            }

                         showPriceBreakdown(pricePerPassenger, passengerCount, totalAmount) {
                 const breakdownElement = document.getElementById('priceBreakdown');
                 const textElement = document.getElementById('priceBreakdownText');
                 
                 if (breakdownElement && textElement) {
                     textElement.textContent = `₹${pricePerPassenger} × ${passengerCount} passengers = ₹${totalAmount}`;
                     breakdownElement.style.display = 'block';
                 }
             }
             
             showUpdateSuccess() {
                 const successHtml = `
                     <div class="alert alert-success alert-dismissible fade show" role="alert">
                         <i class="fas fa-check-circle me-2"></i>
                         <strong>Booking Updated Successfully!</strong> Your changes have been saved.
                         <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                     </div>
                 `;
                 
                 // Insert success message at the top of the editable section
                 const editableSection = document.querySelector('.editable-booking-details');
                 if (editableSection) {
                     editableSection.insertAdjacentHTML('afterbegin', successHtml);
                     
                     // Auto-remove after 5 seconds
                     setTimeout(() => {
                         const alert = editableSection.querySelector('.alert');
                         if (alert) {
                             alert.remove();
                         }
                     }, 5000);
                 }
             }
        }

        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new BookingDetailsPage();
        });
    </script>
</body>
</html>
